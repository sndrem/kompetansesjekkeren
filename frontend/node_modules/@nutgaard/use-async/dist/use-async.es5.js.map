{"version":3,"file":"use-async.es5.js","sources":["../src/use-async.ts"],"sourcesContent":["import { DependencyList, useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nexport enum Status {\n  INIT = 'INIT',\n  PENDING = 'PENDING',\n  OK = 'OK',\n  ERROR = 'ERROR',\n  RELOADING = 'RELOADING'\n}\n\nexport type WithoutData = { status: Status.INIT | Status.PENDING };\nexport type WithData<TYPE> = { status: Status.OK | Status.RELOADING; data: TYPE };\nexport type WithError = { status: Status.ERROR; error: any };\nexport type AsyncData<TYPE> = WithoutData | WithData<TYPE> | WithError;\n\nexport type AsyncResult<TYPE> = AsyncData<TYPE> & {\n  rerun(): void;\n};\n\nexport function isPending(result: AsyncData<any>): result is WithoutData {\n  return [Status.INIT, Status.PENDING].includes(result.status);\n}\n\nexport function hasData<TYPE>(result: AsyncData<TYPE>): result is WithData<TYPE> {\n  return [Status.OK, Status.RELOADING].includes(result.status);\n}\n\nexport function hasError(result: AsyncData<any>): result is WithError {\n  return result.status === Status.ERROR;\n}\n\nexport default function useAsync<TYPE>(\n  source: (isRerun: boolean) => Promise<TYPE>,\n  lazy: boolean = false,\n  dependencyList?: DependencyList,\n  initialState?: AsyncData<TYPE>\n): AsyncResult<TYPE> {\n  const isCancelled = useRef(false);\n  const [rerunValue, setRerunValue] = useState(0);\n  const lastRerun = useRef(rerunValue);\n  const [state, setState] = useState<AsyncData<TYPE>>(\n    initialState || {\n      status: lazy ? Status.INIT : Status.PENDING\n    }\n  );\n\n  useEffect(\n    () => {\n      const isRerun = lastRerun.current !== rerunValue;\n      lastRerun.current = rerunValue;\n\n      if (!lazy || (isRerun && ![Status.PENDING, Status.RELOADING].includes(state.status))) {\n        if (state.status === Status.OK) {\n          setState({ status: Status.RELOADING, data: state.data });\n        } else {\n          setState({ status: Status.PENDING });\n        }\n\n        source(isRerun).then(\n          (data) => {\n            if (!isCancelled.current) {\n              setState({ status: Status.OK, data });\n            }\n          },\n          (error) => {\n            console.error(error);\n            if (!isCancelled.current) {\n              setState({ status: Status.ERROR, error });\n            }\n          }\n        );\n      }\n      // Alle skal være med, men eslint greier ikke å analysere den\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n    },\n    dependencyList\n      ? [...dependencyList, rerunValue, lazy, isCancelled]\n      : [source, rerunValue, lazy, isCancelled]\n  );\n\n  useEffect(() => {\n    return () => {\n      isCancelled.current = true;\n    };\n  }, [isCancelled]);\n\n  const rerun = useCallback(() => {\n    setRerunValue((v) => v + 1);\n  }, []);\n\n  return useMemo(() => ({ ...state, rerun }), [state, rerun]);\n}\n"],"names":[],"mappings":"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"}